# Kubernetes ConfigMaps for Manufacturing Knowledge Base
# Configuration data for all services and components

---
# Application Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: knowledge-base-config
  namespace: knowledge-base
  labels:
    app: knowledge-base
    component: config
data:
  # Database Configuration
  DATABASE_URL: "sqlite:///data/knowledge_base.db"
  DATABASE_BACKUP_ENABLED: "true"
  DATABASE_BACKUP_SCHEDULE: "0 2 * * *"

  # API Configuration
  API_RATE_LIMIT: "1000"
  API_TIMEOUT: "30"
  API_RETRIES: "3"
  LOG_LEVEL: "INFO"
  LOG_FORMAT: "json"

  # CORS Configuration
  CORS_ORIGINS: "https://knowledge-base.company.com,https://app.knowledge-base.company.com"

  # Cache Configuration
  REDIS_URL: "redis://redis-service:6379/0"
  CACHE_TTL: "3600"

  # Feature Flags
  PROMETHEUS_ENABLED: "true"
  JAEGER_ENABLED: "true"
  LOKI_ENABLED: "false"
  OBSERVABILITY_ENABLED: "true"

  # Security Configuration
  GDPR_COMPLIANCE: "true"
  ENCRYPTION_AT_REST: "true"
  AUDIT_LOGGING: "true"

  # Manufacturing-specific Configuration
  MANUFACTURING_MODE: "true"
  QUALITY_CONTROL_ENABLED: "true"
  COMPLIANCE_TRACKING: "true"

  # Performance Configuration
  MAX_CONCURRENT_QUERIES: "100"
  QUERY_TIMEOUT: "30"
  BATCH_SIZE: "50"

---
# Knowledge API Specific Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: knowledge-api-config
  namespace: knowledge-base
  labels:
    app: knowledge-api
    component: config
data:
  SERVICE_NAME: "knowledge-api"
  SERVICE_PORT: "8001"
  METRICS_PORT: "9001"

  # Embedding Configuration
  EMBEDDING_MODEL: "sentence-transformers/all-MiniLM-L6-v2"
  EMBEDDING_DIMENSION: "384"
  VECTOR_STORE_TYPE: "chromadb"

  # Search Configuration
  SEARCH_TOP_K: "10"
  SEARCH_THRESHOLD: "0.7"
  HYBRID_SEARCH_ENABLED: "true"

  # Document Processing
  MAX_DOCUMENT_SIZE: "50MB"
  SUPPORTED_FORMATS: "pdf,docx,txt,md,jpg,png"
  PROCESSING_TIMEOUT: "300"

---
# Chat API Specific Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: chat-api-config
  namespace: knowledge-base
  labels:
    app: chat-api
    component: config
data:
  SERVICE_NAME: "chat-api"
  SERVICE_PORT: "8002"
  METRICS_PORT: "9002"

  # LLM Configuration
  CHAT_MODEL: "gpt-4"
  CHAT_TEMPERATURE: "0.7"
  MAX_TOKENS: "2000"
  SYSTEM_PROMPT: "You are a helpful AI assistant specializing in manufacturing knowledge and industrial processes."

  # Conversation Configuration
  MAX_CONVERSATION_LENGTH: "20"
  CONTEXT_WINDOW_SIZE: "10"
  SESSION_TIMEOUT: "3600"

  # Safety Configuration
  CONTENT_FILTERING: "true"
  PROFANITY_FILTER: "true"
  RATE_LIMIT_PER_USER: "50"

---
# Reminders API Specific Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: reminders-api-config
  namespace: knowledge-base
  labels:
    app: reminders-api
    component: config
data:
  SERVICE_NAME: "reminders-api"
  SERVICE_PORT: "8000"
  METRICS_PORT: "9000"

  # Email Configuration
  SMTP_HOST: "smtp.company.com"
  SMTP_PORT: "587"
  SMTP_USE_TLS: "true"
  EMAIL_FROM: "noreply@knowledge-base.company.com"

  # Reminder Configuration
  DEFAULT_REMINDER_TIME: "09:00"
  MAX_REMINDERS_PER_USER: "100"
  REMINDER_BATCH_SIZE: "50"

  # Notification Channels
  EMAIL_ENABLED: "true"
  SMS_ENABLED: "false"
  WEBHOOK_ENABLED: "true"

---
# Frontend Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: frontend-config
  namespace: knowledge-base
  labels:
    app: frontend
    component: config
data:
  # API Endpoints
  API_BASE_URL: "https://api.knowledge-base.company.com"
  CHAT_API_URL: "https://chat-api.knowledge-base.company.com"
  REMINDERS_API_URL: "https://reminders-api.knowledge-base.company.com"
  WEBSOCKET_URL: "wss://api.knowledge-base.company.com/ws"

  # Application Configuration
  APP_NAME: "Manufacturing Knowledge Base"
  APP_VERSION: "1.0.0"
  ENVIRONMENT: "production"

  # Feature Flags
  ADVANCED_SEARCH_ENABLED: "true"
  CHAT_ENABLED: "true"
  REMINDERS_ENABLED: "true"
  ANALYTICS_ENABLED: "true"

  # UI Configuration
  THEME: "light"
  LANGUAGE: "en"
  TIMEZONE: "UTC"

  # Performance
  CACHE_BUSTING: "true"
  LAZY_LOADING: "true"
  INFINITE_SCROLL: "false"

---
# Monitoring Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: monitoring-config
  namespace: knowledge-base
  labels:
    app: monitoring
    component: config
data:
  # Prometheus Configuration
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    rule_files:
      - "/etc/prometheus/rules/*.yml"

    alerting:
      alertmanagers:
        - static_configs:
            - targets:
              - alertmanager:9093

    scrape_configs:
      - job_name: 'knowledge-api'
        static_configs:
          - targets: ['knowledge-api-service:9001']
        metrics_path: '/metrics'
        scrape_interval: 30s

      - job_name: 'chat-api'
        static_configs:
          - targets: ['chat-api-service:9002']
        metrics_path: '/metrics'
        scrape_interval: 30s

      - job_name: 'reminders-api'
        static_configs:
          - targets: ['reminders-api-service:9000']
        metrics_path: '/metrics'
        scrape_interval: 30s

      - job_name: 'redis'
        static_configs:
          - targets: ['redis-service:9121']
        scrape_interval: 30s

      - job_name: 'node-exporter'
        static_configs:
          - targets: ['node-exporter:9100']
        scrape_interval: 30s

  # Alert Rules
  alert-rules.yml: |
    groups:
    - name: knowledge-base
      rules:
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value }} errors per second"

      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High response time detected"
          description: "95th percentile response time is {{ $value }} seconds"

      - alert: HighMemoryUsage
        expr: (container_memory_usage_bytes / container_spec_memory_limit_bytes) > 0.85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage detected"
          description: "Memory usage is {{ $value | humanizePercentage }}"

      - alert: HighCPUUsage
        expr: rate(container_cpu_usage_seconds_total[5m]) > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage is {{ $value | humanizePercentage }}"

---
# Nginx Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: knowledge-base
  labels:
    app: frontend
    component: nginx
data:
  nginx.conf: |
    user nginx;
    worker_processes auto;
    error_log /var/log/nginx/error.log warn;
    pid /var/run/nginx.pid;

    events {
        worker_connections 1024;
        use epoll;
        multi_accept on;
    }

    http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for"';

        access_log /var/log/nginx/access.log main;

        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;

        gzip on;
        gzip_vary on;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/atom+xml image/svg+xml;

        upstream knowledge-api {
            server knowledge-api-service:8001;
        }

        upstream chat-api {
            server chat-api-service:8002;
        }

        upstream reminders-api {
            server reminders-api-service:8000;
        }

        server {
            listen 80;
            server_name _;
            root /usr/share/nginx/html;
            index index.html;

            location / {
                try_files $uri $uri/ /index.html;

                location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                    expires 1y;
                    add_header Cache-Control "public, immutable";
                }
            }

            location /api/ {
                proxy_pass http://knowledge-api/;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }

            location /chat-api/ {
                proxy_pass http://chat-api/;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;

                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
            }

            location /reminders-api/ {
                proxy_pass http://reminders-api/;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }

            location /ws/ {
                proxy_pass http://knowledge-api:8765/;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_set_header Host $host;
                proxy_read_timeout 86400s;
                proxy_send_timeout 86400s;
            }
        }
    }