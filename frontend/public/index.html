<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥è¯†åº“ç®¡ç†ç³»ç»Ÿ - æé†’ä¸­å¿ƒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }

        .nav-tabs {
            background: white;
            padding: 0 2rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 2rem;
        }

        .nav-tab {
            padding: 1rem 0;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-tab:hover {
            color: #667eea;
        }

        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-healthy {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .priority-high {
            color: #dc3545;
            font-weight: 600;
        }

        .priority-medium {
            color: #ffc107;
            font-weight: 600;
        }

        .priority-low {
            color: #28a745;
            font-weight: 600;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }

        .chart-container {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .refresh-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>ğŸ”” çŸ¥è¯†åº“ç®¡ç†ç³»ç»Ÿ - æé†’ä¸­å¿ƒ</h1>
    </header>

    <nav class="nav-tabs">
        <div class="nav-tab active" onclick="switchTab('reminders')">æé†’ä¸­å¿ƒ</div>
        <div class="nav-tab" onclick="switchTab('statistics')">ç»Ÿè®¡è§†å›¾</div>
        <div class="nav-tab" onclick="switchTab('analysis')">æ•°æ®åˆ†æ</div>
    </nav>

    <div class="container">
        <!-- æé†’ä¸­å¿ƒæ ‡ç­¾é¡µ -->
        <div id="reminders" class="tab-content active">
            <!-- ç³»ç»Ÿå¥åº·çŠ¶æ€ -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ç³»ç»Ÿå¥åº·çŠ¶æ€</h3>
                    <span id="system-status" class="status-badge status-healthy">æ£€æŸ¥ä¸­...</span>
                </div>
                <div id="system-health-content">
                    <div class="loading">æ­£åœ¨åŠ è½½ç³»ç»Ÿå¥åº·ä¿¡æ¯...</div>
                </div>
            </div>

            <!-- æé†’è§„åˆ™ç»Ÿè®¡ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div id="total-rules" class="stat-value">-</div>
                    <div class="stat-label">æ€»è§„åˆ™æ•°</div>
                </div>
                <div class="stat-card">
                    <div id="active-rules" class="stat-value">-</div>
                    <div class="stat-label">æ´»è·ƒè§„åˆ™</div>
                </div>
                <div class="stat-card">
                    <div id="today-reminders" class="stat-value">-</div>
                    <div class="stat-label">ä»Šæ—¥æé†’</div>
                </div>
                <div class="stat-card">
                    <div id="success-rate" class="stat-value">-</div>
                    <div class="stat-label">æˆåŠŸç‡</div>
                </div>
            </div>

            <!-- æé†’è§„åˆ™åˆ—è¡¨ -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">æé†’è§„åˆ™</h3>
                    <button class="btn btn-primary btn-sm" onclick="refreshRules()">åˆ·æ–°</button>
                </div>
                <div id="rules-content">
                    <div class="loading">æ­£åœ¨åŠ è½½æé†’è§„åˆ™...</div>
                </div>
            </div>

            <!-- æœ€è¿‘æ´»åŠ¨ -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">æœ€è¿‘æ´»åŠ¨</h3>
                    <button class="btn btn-primary btn-sm" onclick="refreshActivity()">åˆ·æ–°</button>
                </div>
                <div id="activity-content">
                    <div class="loading">æ­£åœ¨åŠ è½½æ´»åŠ¨è®°å½•...</div>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡è§†å›¾æ ‡ç­¾é¡µ -->
        <div id="statistics" class="tab-content">
            <!-- å›¾çº¸åˆ†ç±»ç»Ÿè®¡ -->
            <div class="chart-container">
                <div class="card-header">
                    <h3 class="card-title">å›¾çº¸åˆ†ç±»åˆ†å¸ƒ</h3>
                    <button class="btn btn-primary btn-sm" onclick="refreshStatistics()">åˆ·æ–°</button>
                </div>
                <div id="drawing-stats-content">
                    <div class="loading">æ­£åœ¨åŠ è½½å›¾çº¸ç»Ÿè®¡...</div>
                </div>
            </div>

            <!-- å®¢æˆ·çŠ¶æ€ç»Ÿè®¡ -->
            <div class="chart-container">
                <div class="card-header">
                    <h3 class="card-title">å®¢æˆ·çŠ¶æ€åˆ†å¸ƒ</h3>
                </div>
                <div id="customer-stats-content">
                    <div class="loading">æ­£åœ¨åŠ è½½å®¢æˆ·ç»Ÿè®¡...</div>
                </div>
            </div>

            <!-- å·¥å‚æŠ¥ä»·ç»Ÿè®¡ -->
            <div class="chart-container">
                <div class="card-header">
                    <h3 class="card-title">å·¥å‚æŠ¥ä»·è¶‹åŠ¿</h3>
                </div>
                <div id="factory-stats-content">
                    <div class="loading">æ­£åœ¨åŠ è½½å·¥å‚ç»Ÿè®¡...</div>
                </div>
            </div>
        </div>

        <!-- æ•°æ®åˆ†ææ ‡ç­¾é¡µ -->
        <div id="analysis" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">æ•°æ®è´¨é‡åˆ†æ</h3>
                </div>
                <div id="quality-analysis-content">
                    <div class="loading">æ­£åœ¨åŠ è½½æ•°æ®è´¨é‡åˆ†æ...</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">è¶‹åŠ¿åˆ†æ</h3>
                </div>
                <div id="trend-analysis-content">
                    <div class="loading">æ­£åœ¨åŠ è½½è¶‹åŠ¿åˆ†æ...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ·æ–°æŒ‰é’® -->
    <button class="refresh-btn" onclick="refreshAll()" title="åˆ·æ–°æ‰€æœ‰æ•°æ®">
        ğŸ”„
    </button>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function switchTab(tabName) {
            // ç§»é™¤æ‰€æœ‰activeç±»
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // æ·»åŠ activeç±»åˆ°å½“å‰æ ‡ç­¾
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            // åŠ è½½å¯¹åº”æ•°æ®
            if (tabName === 'reminders') {
                loadRemindersData();
            } else if (tabName === 'statistics') {
                loadStatisticsData();
            } else if (tabName === 'analysis') {
                loadAnalysisData();
            }
        }

        // åŠ è½½æé†’æ•°æ®
        async function loadRemindersData() {
            try {
                // åŠ è½½ä»ªè¡¨æ¿æ•°æ®
                const dashboardResponse = await fetch(`${API_BASE}/reminders/dashboard`);
                const dashboardData = await dashboardResponse.json();

                if (dashboardData.success) {
                    updateRemindersDashboard(dashboardData.data);
                }

                // åŠ è½½è§„åˆ™åˆ—è¡¨
                const rulesResponse = await fetch(`${API_BASE}/reminders/rules?limit=10`);
                const rulesData = await rulesResponse.json();

                if (rulesData.success) {
                    updateRulesList(rulesData.data.rules);
                }

            } catch (error) {
                console.error('åŠ è½½æé†’æ•°æ®å¤±è´¥:', error);
                showError('åŠ è½½æé†’æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIæœåŠ¡å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ');
            }
        }

        // æ›´æ–°æé†’ä»ªè¡¨æ¿
        function updateRemindersDashboard(data) {
            // æ›´æ–°ç³»ç»Ÿå¥åº·çŠ¶æ€
            const systemHealth = data.system_health;
            const statusElement = document.getElementById('system-status');
            const healthContent = document.getElementById('system-health-content');

            if (systemHealth.status === 'healthy') {
                statusElement.className = 'status-badge status-healthy';
                statusElement.textContent = 'ç³»ç»Ÿæ­£å¸¸';
                healthContent.innerHTML = `
                    <p><strong>å¤±è´¥ç‡:</strong> ${systemHealth.failure_rate}%</p>
                    <p><strong>è¿è¡Œæ—¶é—´:</strong> ${systemHealth.uptime}</p>
                    <p><strong>æœ€åæ£€æŸ¥:</strong> ${new Date(systemHealth.last_check).toLocaleString()}</p>
                `;
            } else {
                statusElement.className = 'status-badge status-warning';
                statusElement.textContent = 'éœ€è¦å…³æ³¨';
                healthContent.innerHTML = `
                    <p><strong>å¤±è´¥ç‡:</strong> ${systemHealth.failure_rate}%</p>
                    <p><strong>è¿è¡Œæ—¶é—´:</strong> ${systemHealth.uptime}</p>
                    <p><strong>å»ºè®®:</strong> è¯·æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—</p>
                `;
            }

            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            document.getElementById('total-rules').textContent = data.rules.total_rules;
            document.getElementById('active-rules').textContent = data.rules.active_rules;
            document.getElementById('today-reminders').textContent = data.today.total_reminders;

            const successRate = data.today.total_reminders > 0
                ? Math.round((data.today.completed_reminders / data.today.total_reminders) * 100)
                : 0;
            document.getElementById('success-rate').textContent = successRate + '%';

            // æ›´æ–°æœ€è¿‘æ´»åŠ¨
            updateActivityList(data.recent_activity);
        }

        // æ›´æ–°è§„åˆ™åˆ—è¡¨
        function updateRulesList(rules) {
            const content = document.getElementById('rules-content');

            if (rules.length === 0) {
                content.innerHTML = '<p>æš‚æ— æé†’è§„åˆ™</p>';
                return;
            }

            const table = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>è§„åˆ™ID</th>
                            <th>è§„åˆ™åç§°</th>
                            <th>ä¼˜å…ˆçº§</th>
                            <th>è§¦å‘æ¬¡æ•°</th>
                            <th>æœ€åè§¦å‘</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rules.map(rule => `
                            <tr>
                                <td>${rule.rule_id}</td>
                                <td>${rule.name}</td>
                                <td><span class="priority-${rule.priority === 1 ? 'high' : rule.priority === 2 ? 'medium' : 'low'}">
                                    ${rule.priority === 1 ? 'é«˜' : rule.priority === 2 ? 'ä¸­' : 'ä½'}
                                </span></td>
                                <td>${rule.trigger_count || 0}</td>
                                <td>${rule.last_triggered ? new Date(rule.last_triggered).toLocaleString() : 'ä»æœª'}</td>
                                <td>
                                    <button class="btn btn-primary btn-sm" onclick="triggerRule('${rule.rule_id}')">
                                        è§¦å‘
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            content.innerHTML = table;
        }

        // æ›´æ–°æ´»åŠ¨åˆ—è¡¨
        function updateActivityList(activities) {
            const content = document.getElementById('activity-content');

            if (activities.length === 0) {
                content.innerHTML = '<p>æš‚æ— æœ€è¿‘æ´»åŠ¨</p>';
                return;
            }

            const list = activities.map(activity => `
                <div style="padding: 0.75rem 0; border-bottom: 1px solid #e0e0e0;">
                    <strong>${activity.rule_name}</strong>
                    <br>
                    <small style="color: #666;">
                        ${activity.execution_id} -
                        ${new Date(activity.triggered_at).toLocaleString()} -
                        é€šçŸ¥: ${activity.notification_count || 0}ä¸ª
                    </small>
                </div>
            `).join('');

            content.innerHTML = list;
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStatisticsData() {
            try {
                // åŠ è½½å›¾çº¸åˆ†ç±»ç»Ÿè®¡
                const drawingsResponse = await fetch(`${API_BASE}/statistics/drawings/by_category`);
                const drawingsData = await drawingsResponse.json();

                if (drawingsData.success) {
                    updateDrawingStats(drawingsData.data);
                }

                // åŠ è½½å®¢æˆ·ç»Ÿè®¡
                const customersResponse = await fetch(`${API_BASE}/statistics/customers/by_status`);
                const customersData = await customersResponse.json();

                if (customersResponse.success) {
                    updateCustomerStats(customersData.data);
                }

                // åŠ è½½å·¥å‚æŠ¥ä»·è¶‹åŠ¿
                const trendsResponse = await fetch(`${API_BASE}/trends/factory_quotes`);
                const trendsData = await trendsResponse.json();

                if (trendsData.success) {
                    updateFactoryStats(trendsData.data);
                }

            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                showError('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIæœåŠ¡å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ');
            }
        }

        // æ›´æ–°å›¾çº¸ç»Ÿè®¡
        function updateDrawingStats(data) {
            const content = document.getElementById('drawing-stats-content');
            const summary = data.summary;

            content.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div><strong>æ€»å›¾çº¸æ•°:</strong> ${summary.total_drawings}</div>
                    <div><strong>å·²åˆ†ç±»:</strong> ${summary.classified_drawings}</div>
                    <div><strong>åˆ†ç±»ç‡:</strong> ${summary.classification_rate}%</div>
                    <div><strong>æ—¥æœŸèŒƒå›´:</strong> ${summary.date_range.from} è‡³ ${summary.date_range.to}</div>
                </div>
                <h4 style="margin-top: 1rem;">åˆ†ç±»åˆ†å¸ƒ:</h4>
                <div style="margin-top: 0.5rem;">
                    ${data.categories.map(cat => `
                        <div style="padding: 0.5rem 0; border-bottom: 1px solid #f0f0f0;">
                            <strong>${cat.product_category}:</strong> ${cat.count} (${cat.percentage}%)
                            <br>
                            <small>æ ‡å‡†ä»¶: ${cat.standard_count}, å®šåˆ¶ä»¶: ${cat.custom_count}, å¹³å‡ç½®ä¿¡åº¦: ${(cat.avg_confidence * 100).toFixed(1)}%</small>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // æ›´æ–°å®¢æˆ·ç»Ÿè®¡
        function updateCustomerStats(data) {
            const content = document.getElementById('customer-stats-content');
            const summary = data.summary;

            content.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div><strong>æ€»å®¢æˆ·æ•°:</strong> ${summary.total_customers}</div>
                    <div><strong>æ´»è·ƒå®¢æˆ·:</strong> ${summary.active_customers}</div>
                    <div><strong>æ½œåœ¨å®¢æˆ·:</strong> ${summary.potential_customers}</div>
                    <div><strong>å¹³å‡å›¾çº¸æ•°:</strong> ${summary.avg_drawings_per_customer}</div>
                </div>
                <h4 style="margin-top: 1rem;">çŠ¶æ€åˆ†å¸ƒ:</h4>
                <div style="margin-top: 0.5rem;">
                    ${data.status_distribution.map(status => `
                        <div style="padding: 0.5rem 0; border-bottom: 1px solid #f0f0f0;">
                            <strong>${status.customer_status}:</strong> ${status.count} (${status.percentage}%)
                            <br>
                            <small>å¹³å‡å›¾çº¸: ${status.avg_drawings}, è¦†ç›–å›½å®¶: ${status.countries}</small>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // æ›´æ–°å·¥å‚ç»Ÿè®¡
        function updateFactoryStats(data) {
            const content = document.getElementById('factory-stats-content');
            const summary = data.summary;

            content.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div><strong>æ€»æŠ¥ä»·æ•°:</strong> ${summary.total_quotes}</div>
                    <div><strong>å·¥å‚æ•°:</strong> ${summary.total_factories}</div>
                    <div><strong>ä»·æ ¼è¶‹åŠ¿:</strong> ${summary.overall_price_trend > 0 ? '+' : ''}${summary.overall_price_trend}%</div>
                    <div><strong>æ•°æ®èŒƒå›´:</strong> ${summary.date_range.from} è‡³ ${summary.date_range.to}</div>
                </div>
                <h4 style="margin-top: 1rem;">å·¥å‚è¡¨ç°:</h4>
                <div style="margin-top: 0.5rem;">
                    ${data.factory_performance.map(factory => `
                        <div style="padding: 0.5rem 0; border-bottom: 1px solid #f0f0f0;">
                            <strong>${factory.factory_name}:</strong> å¹³å‡ä»·æ ¼ ${factory.avg_price}
                            <br>
                            <small>æŠ¥ä»·æ•°: ${factory.total_quotes}, é¢‘ç‡: ${factory.quote_frequency}/æœˆ</small>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // åŠ è½½åˆ†ææ•°æ®
        async function loadAnalysisData() {
            try {
                // åŠ è½½æ•°æ®è´¨é‡
                const qualityResponse = await fetch(`${API_BASE}/quality/overview`);
                const qualityData = await qualityResponse.json();

                if (qualityData.success) {
                    updateQualityAnalysis(qualityData.data);
                }

                // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šåˆ†ææ•°æ®åŠ è½½

            } catch (error) {
                console.error('åŠ è½½åˆ†ææ•°æ®å¤±è´¥:', error);
                showError('åŠ è½½åˆ†ææ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIæœåŠ¡å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ');
            }
        }

        // æ›´æ–°æ•°æ®è´¨é‡åˆ†æ
        function updateQualityAnalysis(data) {
            const content = document.getElementById('quality-analysis-content');

            content.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    <div>
                        <h4>æ€»ä½“è¯„åˆ†</h4>
                        <div style="font-size: 2rem; font-weight: bold; color: ${data.overall_score >= 80 ? '#28a745' : data.overall_score >= 60 ? '#ffc107' : '#dc3545'};">
                            ${data.overall_score}/100
                        </div>
                        <div>ç­‰çº§: <strong>${data.overall_grade}</strong></div>
                    </div>
                </div>
                <h4 style="margin-top: 1rem;">ç»„ä»¶è¯„åˆ†:</h4>
                <div style="margin-top: 0.5rem;">
                    ${Object.entries(data.component_scores).map(([component, score]) => `
                        <div style="padding: 0.5rem 0; border-bottom: 1px solid #f0f0f0;">
                            <strong>${component}:</strong> ${score.score}/100 (${score.grade})
                            <br>
                            <small>å®Œæ•´æ€§: ${score.completeness}%, å‡†ç¡®æ€§: ${score.accuracy || 'N/A'}%</small>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // è§¦å‘è§„åˆ™
        async function triggerRule(ruleId) {
            try {
                const response = await fetch(`${API_BASE}/reminders/trigger`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ rule_id: ruleId })
                });

                const result = await response.json();
                if (result.success) {
                    alert(`è§„åˆ™ ${ruleId} è§¦å‘æˆåŠŸï¼`);
                    loadRemindersData(); // åˆ·æ–°æ•°æ®
                } else {
                    alert(`è§¦å‘å¤±è´¥: ${result.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('è§¦å‘è§„åˆ™å¤±è´¥:', error);
                alert('è§¦å‘è§„åˆ™å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // åˆ·æ–°å‡½æ•°
        function refreshAll() {
            const activeTab = document.querySelector('.tab-content.active').id;
            if (activeTab === 'reminders') {
                loadRemindersData();
            } else if (activeTab === 'statistics') {
                loadStatisticsData();
            } else if (activeTab === 'analysis') {
                loadAnalysisData();
            }
        }

        function refreshRules() {
            loadRemindersData();
        }

        function refreshActivity() {
            loadRemindersData();
        }

        function refreshStatistics() {
            loadStatisticsData();
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('.container').firstChild);

            // 3ç§’åè‡ªåŠ¨ç§»é™¤é”™è¯¯ä¿¡æ¯
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 3000);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadRemindersData();
        });
    </script>
</body>
</html>